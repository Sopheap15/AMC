---
title: "<center> Antimicrobial consumption </center>"
date: "<center>`r format(Sys.Date(), '%d-%m-%Y')`</center>"
output: html_document
---

<style>
.table-hover > tbody > tr:hover { 
  background-color: #f4f442;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = 'c')
```

## 1. Objectives
The purpose of performing antimicrobial consumption monitoring is to evaluate the trends in antimicrobial use and monitor the progress of antimicrobial stewardship (AMS) program initiative.   

## 2. Background
Antimicrobial usage is the main driver for promoting antibiotic resistance which is considered one of the major health challenges in human and veterinary medicine. To be insightful and able to take action on time, data of antimicrobial consumption should be collected, analysed and communicated regularly. In addition, methods for data analysis should be simple, reproducible and timely. 

Pharmacists in government hospital work closely with the Diagnostic Microbiology Develop Program [(DMDP)](www.dmdp.org) pharmacy mentors to generate a comprehensive report. Raw data was extracted from hospital inventory system "HosDID" into Excel and then imported to R programming for cleaning, analysis and generating reports. The report is in HTML format with is able to open with a wide range of devices. Furthermore, pharmacists in government hospital communicate this finding regularly among hospital members.  


## 3. Monthly antimicrobial dispensing
Data from Siem Reap in 2019   

```{r dispensing}
data %>% 
	select(Antibiotic, form, strength, month, line_total) %>% 
	pivot_wider(names_from = month, values_from = line_total) %>% 
	arrange(Antibiotic) %>% 
	mutate_all(~replace(., is.na(.), 0)) %>% 
	adorn_totals("col") %>% 
	kable(align = c('l','l','l','c','c','c','c','c','c','c','c','c','c','c','c','r'), format.args = list(big.mark = ",")) %>% kable_styling(bootstrap_options = c("bordered","condensed", "striped", "hover","responsive")) %>% 
	collapse_rows(columns = 1, valign = "middle") %>% 
  scroll_box(width = "110%", height = "800px")
		
```

## 4. Antimicrobial consumption
<br>
To be able to compare antimicrobial consumption, we follow the WHO guideline to convert antimicrobial dispensing to defined daily doses (DDDs). Sum up of all antimicrobial, we have `r format(round_half_up(sum(data$ddd_1000)), big.mark=",")` DDDs/1000 patient days.

### 4.1 Monthly Antimicrobial consumption

```{r monthly consumption}
data %>% 
	filter(!is.na(monitoring)) %>% 
	group_by(monitoring, month) %>% 
	summarise(n = sum(ddd_1000)) %>% 
	group_by(month) %>% 
	mutate(pro = round_half_up(n/sum(n)*100)) %>% 
	ggplot(aes(month, pro, fill = monitoring)) +
	geom_bar(stat = "identity") +
	geom_text(aes(label = pro), position = position_stack(vjust = 0.5)) +
	labs(x = "Month", y = "Proportion (%)", title = "WHO AWaRe classification") +
	theme_bw() +
	theme(plot.title = element_text(color = "black", face = "bold", hjust = 0.5),
				legend.title = element_blank()) +
	scale_fill_manual(values = c("#88cc00","#ffcc00"))

```

### 4.2 Define Daily Dose  
```{r ddd}
data %>% 
	group_by(Antibiotic) %>% 
	summarise(ddd_1000 = round(mean(ddd_1000),1)) %>% 
	ggplot(aes(reorder(Antibiotic, ddd_1000), ddd_1000, fill = Antibiotic)) + 
	geom_bar(stat = "identity") + 
	geom_text(aes(label = format(ddd_1000, big.mark = ",")), hjust = -0.2, size = 3) +
	coord_flip() +
	scale_y_continuous(expand = expansion(mult = c(0, .2))) +
	labs(x = "Antimicrobial",
			 y = "DDDs/1000 patient days", 
			 title = "Defined Daily Doses") +
	theme_classic() +
	theme(legend.position = "non",
				plot.title = element_text(hjust = 0.5, colour = "black", face = "bold" ),
				axis.text = element_text(colour = "black", size = 9))

```

### 4.3 Antimicrobial in AWaRe Group  

```{r AB AWaRe}

da <- data %>% 
	filter(!is.na(monitoring)) %>% 
	group_by(monitoring) %>% 
	summarise(n = sum(ddd_1000)) %>% 
	ungroup() %>% 
	mutate(pct = round_half_up(n/sum(n)*100)) 

da %>% 
	ggplot(aes(x = '', y = pct, fill = monitoring)) + 
	geom_bar(stat = "identity") +
	geom_label(aes(label = paste0(monitoring, "\n", pct, "%")),
						position = position_stack(vjust = 0.5)) + 
	coord_polar("y", start = 0, direction = -1) +
 labs(title = "Antimicrobial in WHO AWaRe Groups", 
			 subtitle = paste0("(n= ", format(round_half_up(sum(da$n)), big.mark = ","),")")) + 
	theme_void() +
	theme(legend.position = "non",
				plot.title = element_text(hjust = 0.5,
																	colour = "black", 
																	face = "bold"),
				plot.subtitle = element_text(hjust = 0.5)) +
	scale_fill_manual(values = c("#88cc00","#ffcc00")) # "#88cc00" green, "#ffcc00" yellow
#rm(da)

```

```{r AB in access group}
data %>% 
	select(Antibiotic, monitoring, ddd_1000) %>% 
	filter(monitoring == "Access") %>% 
	group_by(Antibiotic) %>% 
	summarise(n = mean(ddd_1000)) %>% 
	ggplot(aes(reorder(Antibiotic, n), n, fill = Antibiotic)) + 
	geom_bar(stat = "identity") + 
	geom_text(aes(label = format(round_half_up(n), big.mark = ",")), hjust = -0.2, size = 3) +
	labs(title = "Consumption of antimicrobial in Access Group", 
			 x = "Antimicrobial", y = "DDDs/1000 patient days") +
	scale_y_continuous(expand = expansion(mult = c(0.01, .15))) +
	coord_flip() + 
	theme_classic() +
	theme(legend.position = "non",
				axis.text = element_text(colour = "black"),
				plot.title = element_text(hjust = 0.5, colour = "black", face = "bold" ))
```
```{r AB in watch group}
data %>% 
	select(Antibiotic, monitoring, ddd_1000) %>% 
	filter(monitoring == "Watch") %>% 
	group_by(Antibiotic) %>% 
	summarise(n = mean(ddd_1000)) %>% 
	ggplot(aes(reorder(Antibiotic, n), n, fill = Antibiotic)) + 
	geom_bar(stat = "identity") + 
	geom_text(aes(label = format(round_half_up(n), big.mark = ",")), hjust = -0.2, size = 3) +
	labs(title = "Consumption of antimicrobial in Watch Group", 
			 x = "Antimicrobial", y = "DDDs/1000 patient days") +
	scale_y_continuous(expand = expansion(mult = c(0.01, .15))) +
	coord_flip() +
	theme_classic() +
	theme(legend.position = "non",
				axis.text = element_text(colour = "black"),
				plot.title = element_text(hjust = 0.5, colour = "black", face = "bold" ))
```



### 5.  Limitation




### 6.  Recommendation
