---
title: "<center> `r toupper(hospital)` <br> <span style='color:red'> Antimicrobial Consumption </span></center>"
date: "<center> Reported date: `r format(Sys.Date(), '%d-%m-%Y')`</center>"
output: 
    html_document:
        theme: cerulean
---

<style>
.table-hover > tbody > tr:hover { 
  background-color: #f4f442;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = 'c')
```

## 1. Objectives
The purpose of performing antimicrobial consumption monitoring is to evaluate the trends in antimicrobial use and monitor the progress of antimicrobial stewardship (AMS) program initiative.   

## 2. Background
Antimicrobial usage is the main driver for promoting antibiotic resistance which is considered one of the major health challenges in human and veterinary medicine. To be insightful and able to take action on time, data of antimicrobial consumption should be collected, analysed and communicated regularly. In addition, methods for data analysis should be simple, reproducible and timely. 

Pharmacists in government hospitals work closely with the Diagnostic Microbiology Develop Program [(DMDP)](www.dmdp.org) pharmacy mentors to generate a comprehensive report. Raw data was extracted from the hospital inventory system "HosDID" into Excel and then imported to R programming for cleaning, analysis and generating reports. The report is in HTML format which is able to open with a wide range of devices. Furthermore, pharmacists in government hospitals communicate these findings regularly among hospital staff.  

## 3. Monthly antimicrobial dispensing
Data is calculated from <span style="color:red">**`r format(start_date,"%d/%b")` - `r format(end_date, "%d/%b/%Y")`** </span>

```{r dispensing}
data %>% 
	select(Antibiotic, form, strength, month, line_total) %>% 
	pivot_wider(names_from = month, values_from = line_total) %>% 
	arrange(Antibiotic) %>% 
	mutate_all(~replace(., is.na(.), 0)) %>% 
	adorn_totals("col") %>% 
	kable(align = c('l','l','l','c','c','c','c','c','c','c','c','c','c','c','c','r'), format.args = list(big.mark = ",")) %>% kable_styling(bootstrap_options = c("bordered","condensed", "striped", "hover","responsive")) %>% 
	collapse_rows(columns = 1, valign = "middle") %>% 
  scroll_box(width = "110%", height = "800px")
		
```
## 4. Antimicrobial consumption (AMC)
To be able to compare AMC, we follow the WHO guideline to convert antimicrobial dispensing to defined daily doses (DDDs)[c][d]. Sum up of all antimicrobial, we have `r round_half_up(sum(da$ddd_1000_pyear))` DDDs/1000 patient days.

### 4.1 Defined Daily Doses (DDDs)  
```{r ddd}
da %>% 
	ggplot(aes(reorder(Antibiotic, ddd_1000_pyear), ddd_1000_pyear, fill = Antibiotic)) + 
	geom_bar(stat = "identity") + 
	geom_text(aes(label = format(round_half_up(ddd_1000_pyear), big.mark = ",")), hjust = -0.2, size = 3) +
	coord_flip() +
	scale_y_continuous(expand = expansion(mult = c(0, .2))) +
	labs(x = "Antimicrobial",
			 y = "DDDs/1000 patient days", 
			 title = "Defined Daily Doses") +
	theme_classic() +
	theme(legend.position = "non",
				plot.title = element_text(hjust = 0.5, colour = "black", face = "bold" ),
				axis.text = element_text(colour = "black", size = 9))

```

### 4.2 WHO AWaRe Groups
```{r ddd_1000_pyear}
da <- data %>% 
	filter(!is.na(monitoring)) %>% 
	distinct(monitoring, ddd_1000_pyear, .keep_all = T) %>% 
	group_by(Antibiotic, ddd_1000_pyear)
```

As part of the 2017 essential medicines list, WHO[e] introduced a new categorization of antibiotics to guide prescriptions and treatment – AWaRe – and this has been updated in 2019 (23). The AWaRe categorization is based on a methodological approach that takes into consideration the treatment guidelines of the most frequent infectious disease syndromes. The Access group contains antibiotics intended to be used as first- and second-choice therapy. These antibiotics should be consistently available in an appropriate quality and for an affordable price in every country. The Watch group includes mainly broad-spectrum antibiotics, which, because of their higher potential to induce the development of resistance or their unfavourable benefit–risk balance (or both), should only be used for specific indications. The Reserve group represents last resort antibiotics that should only be used if other antibiotics do not work anymore. The AWaRe categorization is supposed to be applied as a tool for antimicrobial stewardship purposes, and should assist countries in their efforts towards optimizing antimicrobial use. The overall goal is to reduce the use of Watch and Reserve group antibiotics, and to increase the relative use and the availability of Access group antibiotics, where needed. In the recent AWaRe campaign, WHO promoted a target of 60% for the use of Access group antibiotics at country level, which should be achieved by 2023 (31). This target has been set for national-level consumption, which is mainly attributed to the consumption arising from outpatients and community care. Nevertheless, the AWaRe categorization might be used for establishing targets adapted to the hospital setting to support local antimicrobial stewardship programmes, and it might serve as an aid in developing restricted formularies (32). 

### 4.2.1 Monthly AMC

```{r monthly consumption}
data %>% 
	filter(!is.na(monitoring)) %>% 
	distinct(monitoring, month, .keep_all = T) %>% 
	group_by(monitoring, month) %>% 
	summarise(n = sum(ddd_1000_pmonth),.groups = "drop") %>% 
	group_by(month) %>% 
	mutate(pro = round_half_up(n/sum(n)*100)) %>% 
	ggplot(aes(month, pro, fill = monitoring)) +
	geom_bar(stat = "identity") +
	geom_text(aes(label = pro), position = position_stack(vjust = 0.5)) +
	labs(x = "Month", y = "Proportion (%)", title = "Monthly WHO AWaRe Groups") +
	theme_bw() +
	theme(plot.title = element_text(color = "black", face = "bold", hjust = 0.5),
				legend.title = element_blank()) +
	scale_fill_manual(values = c("#88cc00","#ffcc00"))

```
  
### 4.3.1 Yearly AMC

```{r AB AWaRe}

d <- da %>% 
	group_by(monitoring) %>% 
	summarise(n = sum(ddd_1000_pyear)) %>% 
	ungroup() %>% 
	mutate(pct = round_half_up(n/sum(n)*100)) 

d %>% 
	ggplot(aes(x = '', y = pct, fill = monitoring)) + 
	geom_bar(stat = "identity") +
	geom_label(aes(label = paste0(monitoring, "\n", pct, "%")),
						position = position_stack(vjust = 0.5)) + 
	coord_polar("y", start = 0, direction = -1) +
 labs(title = "Yearly WHO AWaRe Groups", 
			 subtitle = paste0("(n= ", format(round_half_up(sum(d$n)), big.mark = ","),")")) + 
	theme_void() +
	theme(legend.position = "non",
				plot.title = element_text(hjust = 0.5,
																	colour = "black", 
																	face = "bold"),
				plot.subtitle = element_text(hjust = 0.5)) +
	scale_fill_manual(values = c("#88cc00","#ffcc00")) # "#88cc00" green, "#ffcc00" yellow
#rm(da)

```

```{r AB in access group}
da %>% 
	filter(monitoring == "Access") %>% 
	group_by(Antibiotic) %>% 
	summarise(n = mean(ddd_1000_pyear)) %>% 
	ggplot(aes(reorder(Antibiotic, n), n, fill = Antibiotic)) + 
	geom_bar(stat = "identity") + 
	geom_text(aes(label = format(round_half_up(n), big.mark = ",")), hjust = -0.2, size = 3) +
	labs(title = "Yearly AMC in Access Group", 
			 x = "Antimicrobial", y = "DDDs/1000 patient days") +
	scale_y_continuous(expand = expansion(mult = c(0.01, .15))) +
	coord_flip() + 
	theme_classic() +
	theme(legend.position = "non",
				axis.text = element_text(colour = "black"),
				plot.title = element_text(hjust = 0.5, colour = "black", face = "bold" ))
```
```{r AB in watch group}
da %>% 
	filter(monitoring == "Watch") %>% 
	group_by(Antibiotic) %>% 
	summarise(n = mean(ddd_1000_pyear)) %>% 
	ggplot(aes(reorder(Antibiotic, n), n, fill = Antibiotic)) + 
	geom_bar(stat = "identity") + 
	geom_text(aes(label = format(round_half_up(n), big.mark = ",")), hjust = -0.2, size = 3) +
	labs(title = "Yearly AMC in Watch Group", 
			 x = "Antimicrobial", y = "DDDs/1000 patient days") +
	scale_y_continuous(expand = expansion(mult = c(0.01, .15))) +
	coord_flip() +
	theme_classic() +
	theme(legend.position = "non",
				axis.text = element_text(colour = "black"),
				plot.title = element_text(hjust = 0.5, colour = "black", face = "bold" ))
```



### 5.  Limitations
This report has limitations that need to be recognized:  
* The quality of this report is only as reliable as the quality of the data provided by HosDID to generate this report.  
* Antibiotics purchased from private pharmacies for patients are not included in HosDID data.  
* DDDs are a unit of measure intended for an adult population. This data may include data from pediatric patients, who generally require a lower total daily dose of an antibiotic compared to adults.   
* AMC monitoring only provides quantitative data; more informative qualitative data can be obtained through conducting an antimicrobial Point Prevalence Survey (PPS).

### 6.  Recommendation

[a]Should we make this customizable for the user to select the time frame they wish to analyze? Or would it automatically know based on the HOSDID data provided? AMC typically reviewed annually.
[b]We can put date in data data dictionary for customer to choose.
[c]Should define DDDs and explain more thoroughly the units involved for measurement
[d]Could your team elaborate more on this part to make it understandable for non technical person.
[e]Main WHO document for hospital AMC monitoring:

https://www.who.int/publications/i/item/9789240000421
